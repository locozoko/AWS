# Zscaler Cloud Connector Cluster Infrastructure Setup

**Terraform configurations and modules for deploying Zscaler Cloud Connector Cluster in AWS.**

## Prerequisites (You will be prompted for AWS keys and region during deployment)

1. A valid AWS account
2. AWS ACCESS KEY ID
3. AWS SECRET ACCESS KEY
4. AWS Region (E.g. us-west-2)
5. Subscribe and accept terms of using CentOS 7 at [this link](https://aws.amazon.com/marketplace/pp/B00O7WM7QW/).
7. The public IP address (E.g. AWS Elastic IP) from which Cloud Connector will access the Zscaler Cloud
8. A valid ZScaler Cloud Connector cloud-init file
9. Zscaler Cloud Connector Credentials are stored in AWS Secrets Manager

## Cloning the repo

`git clone https://bitbucket.corp.zscaler.com/scm/ec/bac_utils.git`

## Deploying the cluster
(The automated tool can run only from MacOS and Linux)   
 
**1. Greenfield Deployments**

(Use this if you are building an entire cluster from ground up.
 Particularly useful for a Customer Demo/PoC or dev-test environment)

```
bash
cd aws/deployment/terraform
cp <path to your cloud-init file> user_data
./zsec up
```
**Deployment Type:**

```
Deployment Type: (base | base_1cc | base_1cc_zpa | base_2cc | base_2cc_zpa):
base: Centos server workload + Bastion Host
base_1cc: Centos server workload + Bastion Host + 1 Cloud Connector
base_1cc_zpa: Centos server workload + Bastion Host + 1 Cloud Connector + Route53 for ZPA
base_2cc: Centos server workload + Bastion Host + 2 Cloud Connectors
base_2cc_zpa: Centos server workload + Bastion Host + 2 Cloud Connectors + Route53 for ZPA
```

## Destroying the cluster
```
./zsec destroy
```

## Notes

1. For auto approval set environment variable **AUTO_APPROVE** or add `export AUTO_APPROVE=1`
2. For deployment type set environment variable **DTYPE** to the required deployment type or add `export DTYPE=base_1cc_zpa`
3. To assign a pre-allocated EIP to the NAT gateway For deployment set environment variables
 **TF_VAR_byo_eip_address** and **TF_VAR_nat_eip_id** or add `export TF_VAR_byo_eip_address=true` and
 `export TF_VAR_nat_eip1_id=eipalloc-0ccaee5e62db53d3e`
4. To override the default CC image for your deployment, edit `images` in tfdir/modules/terraform-zscc-aws/images.tf
5. To override the Cloud Connector instance type from t3.medium, edit `ccvm-instance-type` in terraform.tfvars
6. To provide new credentials or region, delete the autogenerated .zsecrc file in your current working directory and re-run zsec.

**2. Brownfield Deployments**

The following Cloud Connector terraform modules are provided for a brownfield deployment
 ```

ls aws/deployment/terraform/tfdir/modules
terraform-zscc-aws
terraform-zsroute53-aws
terraform-zslambda-aws
```
